//


// http://www.murphywong.net/hello/simple.htm#L10

: CCells ( ndx -- size ) ;
: ICells 2 * ;
: LCells 4 * ;
: WCells 4 * ;
: CArray < ( <type size> -- array )
: IArray < ( <type size> -- array )
  ICells Array ; IMMEDIATE
: LArray < ( <type size> -- array )
: WArray < ( <type size> -- array )




: c@				// 4 myarray c@
: c=				// someValue 4 myarray c=
: @
: =
: l@
: l=
: w@
: w=


: nextTokenFromInput ( charArray -- )

:

CHARACTER 4 Array myArray
someValue myArray 3 [] c=
myArray 3 cells + c@ .

CHARACTER Variable myChar
someValue myChar c=
myChar c@ .


// A code block [ code ] always pushes itself on the stack when it is executed by the
// interpreter as a thread. The "execute" word will actually execute the blocks contents

switch case [ condition ] [ action ] case [ condition ] [ action ] endswitch
[ condition ] if [ action ]
[ condition ] [ action ] if

[ condition ] if: [ action1 ] else:

// [ condition ] ifTrue: [ action1] ifFalse: [ action2 ]
[ condition ] [ action1 ] [ action2 ] if:else:()

// [ condition ] whiletrue: [ action ]
[ condition ] [ action ] whileTrue:()

// [ condition ] repeatUntilFalse: [ action ]
[ condition ] [ action ] repeatUntilFalse:()

// start to: finish do: [ action ]
start finish [ action ] to:do:()

// ---------------------------------------------------
// input routines
: readCharExt()
	( read a character from external input )
	primative ### ;

: charInString ( char string -- bool )
	( search a string to see if it contains the specified character )
	[ dup c@ 0 != ] while: [		( char string )
		[ 2dup c@ == ] if: [		( char string )
		  swap						( string char )
		  drop						( string )
		  return					( string )
		] else [
		  1+						( char string+1 )
		]
	]
	2drop							( )
	false							( false )
;

: readCharExtUntil ( stringOfStopCharacters inputBuffer -- stopCharFound )
	( fill the input buffer with characters until a stop character is reached )
	[ readCharExt() over



CHARACTER 256 ARRAY extInputBuffer
INTEGER VARIABLE extInputPosition 0 extInputPosition !
: nextExtInputChar ( -- char )
	( return the next character in extInputBuffer, filling the buffer if needed)
CHARACTER 256 ARRAY tokenBuffer
: currentToken ( -- addr )
	( return a pointer to the current token )
: nextToken ( - addr )
	( read a new token from the input stream and return a pointer to it )



// ---------------------------------------------------

( Outer interpreter )


: return
	primative ### ;

: @
	primative ### ;

: !  ( vaule addr -- )
	primative ### ;

: c@
	primative ### ;

: c!  ( vaule addr -- )
	primative ### ;

: execute()
	primative ### ;

: pick()
	primative ### ;

: rot()
	primative ### ;

: dup()
	0 pick() ;

: over()
	1 pick() ;

: drop()
	primative ### ;
: 2Drop()
	drop() drop();
: 3Drop()
	2Drop() drop();

: emitChar() ( char -- )
	primative ### ;

: readChar() ( -- char ) ( read a character from external input )
	primative ### ;

: [
	primative ### ;

: whileTrue:
	primative ### ;

: if:else:
	primative ### ;


: CHARACTER 1 ;

: Array

: Variable

: readUntilCharacter() ( buffer char -- )
	[ readChar() 2dup != ] whileTrue:
	[				( buffer char inputChar -- )
		rot()		( char inputChar buffer )
		2dup		( char inputChar buffer inputChar buffer )
		c! 1+		( char inputChar buffer )
		rot()		( inputChar buffer char )
		rot()		( buffer char inputChar )
		drop()		( buffer char )
	] ( buffer char inputChar -- )
	3drop();
	inputBuffer 0 c!	( zero terminate token )
;

: (
	[ readChar() 41 != ] whileTrue: [ ] ( 41 is a right paren )
;

: isNumberChar() ( char -- bool )
	[ [ dup 0 >= ] or: [ dup 9 <=] ] if: [
		drop()
		1
	] else: [
		drop()
		0
	]
;

: parseNumber()	( inputBuffer -- value )
	0									( inputBuffer 0)
	[ over() c@ ] whileTrue: [			( inputBuffer value )
		over() c@ 48 -	+				( inputBuffer value )
		swap 1+ swap					( inputBuffer+1 value)
	]
; ( inputBuffer+n value )

: findWord()

: currentToken()
: nextToken()


: " ( inputBufferAddr -- )
	34 readUntilCharacter() ( 34 is a quoate character)
;

: emit() ( stringAddr -- )
	[ dup c@ 0 != ]	whileTrue: [	( is current character a string terminator, 0x00? )
		dup c@ emitChar()			( emit the character )
		1 +							( move the pointer to the next character )
	]
;

CHARACTER Variable systemRunning
CHARACTER 256 Array inputBuffer

: OuterInterp
	[ systemRunning c@ ] whileTrue: [
		inputBuffer readToken()
		[ inputBuffer c@ isNumberChar() ] if: [
			inputBuffer parseNumber()
		] else: [
			( not a mumber, so it must be a word )
			[ inputBuffer findWord() dup() ] if: [
				execute()
			] else: [
				drop()
				" ?" emit()
			]
		]
	]
;





